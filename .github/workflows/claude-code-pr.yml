# GitHub Action: Claude Code PR Assistant
# ========================================
# Baseado no workflow Boris Cherny para @.claude em PRs
#
# Quando alguém comenta @.claude em um PR:
# 1. Claude analisa o contexto do PR
# 2. Responde com insights/sugestões
# 3. Pode atualizar CLAUDE.md se solicitado
#
# Referência: Boris Cherny GitHub Action for Claude Code

name: Claude Code PR Assistant

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

# Only run when comment contains @.claude or @claude
jobs:
  claude-pr-assistant:
    # Only run on PR comments containing @.claude or @claude
    if: |
      (github.event.issue.pull_request || github.event.pull_request) &&
      (contains(github.event.comment.body, '@.claude') || contains(github.event.comment.body, '@claude'))

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get PR details
        id: pr-details
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue?.number || context.payload.pull_request?.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            return {
              title: pr.title,
              body: pr.body || '',
              branch: pr.head.ref,
              base: pr.base.ref,
              files: files.map(f => ({ filename: f.filename, status: f.status, additions: f.additions, deletions: f.deletions })),
              comment: context.payload.comment.body,
              comment_author: context.payload.comment.user.login
            };

      - name: Parse Claude command
        id: parse-command
        run: |
          COMMENT="${{ fromJson(steps.pr-details.outputs.result).comment }}"

          # Extract command after @.claude or @claude
          COMMAND=$(echo "$COMMENT" | sed -n 's/.*@\.claude\s*\(.*\)/\1/p' | head -1)
          if [ -z "$COMMAND" ]; then
            COMMAND=$(echo "$COMMENT" | sed -n 's/.*@claude\s*\(.*\)/\1/p' | head -1)
          fi

          # Default to "review" if no specific command
          if [ -z "$COMMAND" ]; then
            COMMAND="review this PR"
          fi

          echo "command=$COMMAND" >> $GITHUB_OUTPUT

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Run Claude analysis
        id: claude-analysis
        run: |
          # Create context file
          cat > /tmp/pr_context.md << 'EOF'
          # PR Context

          ## PR: ${{ fromJson(steps.pr-details.outputs.result).title }}

          **Branch:** ${{ fromJson(steps.pr-details.outputs.result).branch }} -> ${{ fromJson(steps.pr-details.outputs.result).base }}

          **Files Changed:**
          ${{ toJson(fromJson(steps.pr-details.outputs.result).files) }}

          **PR Description:**
          ${{ fromJson(steps.pr-details.outputs.result).body }}

          ## User Request

          @${{ fromJson(steps.pr-details.outputs.result).comment_author }} asked:
          ${{ steps.parse-command.outputs.command }}
          EOF

          # Run Claude
          RESPONSE=$(claude --print "$(cat /tmp/pr_context.md)" 2>&1 || echo "Error running Claude")

          # Save response for next step
          echo "$RESPONSE" > /tmp/claude_response.md

          # Truncate if too long
          if [ ${#RESPONSE} -gt 65000 ]; then
            RESPONSE="${RESPONSE:0:65000}... (truncated)"
          fi

          # Set output
          echo "response<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Post response as comment
        uses: actions/github-script@v7
        with:
          script: |
            const response = `${{ steps.claude-analysis.outputs.response }}`;
            const prNumber = context.issue?.number || context.payload.pull_request?.number;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## Claude Code Response

            ${response}

            ---
            *Triggered by @${{ fromJson(steps.pr-details.outputs.result).comment_author }}'s comment*`
            });

      - name: Check if CLAUDE.md update requested
        id: check-update
        run: |
          COMMAND="${{ steps.parse-command.outputs.command }}"
          if echo "$COMMAND" | grep -qi "update.*claude.md\|atualizar.*claude.md\|add.*rule\|adicionar.*regra"; then
            echo "update_requested=true" >> $GITHUB_OUTPUT
          else
            echo "update_requested=false" >> $GITHUB_OUTPUT
          fi

      - name: Update CLAUDE.md if requested
        if: steps.check-update.outputs.update_requested == 'true'
        run: |
          # Create a new branch for the update
          git config user.name "Claude Code Bot"
          git config user.email "claude-code-bot@users.noreply.github.com"

          BRANCH="claude-update-$(date +%s)"
          git checkout -b $BRANCH

          # Append context to CLAUDE.md
          echo "" >> CLAUDE.md
          echo "## Auto-generated from PR #${{ github.event.issue.number || github.event.pull_request.number }}" >> CLAUDE.md
          echo "" >> CLAUDE.md
          echo "Request: ${{ steps.parse-command.outputs.command }}" >> CLAUDE.md
          echo "" >> CLAUDE.md

          git add CLAUDE.md
          git commit -m "docs: Update CLAUDE.md from PR comment

          Triggered by @${{ fromJson(steps.pr-details.outputs.result).comment_author }}
          PR: #${{ github.event.issue.number || github.event.pull_request.number }}"

          git push origin $BRANCH

          echo "Created update branch: $BRANCH"
