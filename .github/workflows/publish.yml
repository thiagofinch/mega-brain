name: Publish to npm

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Verify package
        run: |
          echo "Verifying package..."
          node --check bin/cli.js
          node --check bin/mega-brain.js
          node --check bin/lib/installer.js
          node --check bin/lib/validate-email.js
          node --check bin/lib/ascii-art.js
          node --check bin/lib/setup-wizard.js
          node --check bin/push.js
          echo "All syntax checks passed"

      - name: Dry run pack
        run: |
          npm pack --dry-run 2>&1 | tail -10
          echo "Package ready for publish"

      - name: Security scan — secret detection
        run: |
          echo "Installing trufflehog (pinned release)..."
          TRUFFLEHOG_VERSION="3.88.22"
          curl -sSfL "https://github.com/trufflesecurity/trufflehog/releases/download/v${TRUFFLEHOG_VERSION}/trufflehog_${TRUFFLEHOG_VERSION}_linux_amd64.tar.gz" -o trufflehog.tar.gz
          tar xzf trufflehog.tar.gz -C /usr/local/bin trufflehog
          rm trufflehog.tar.gz

          echo "Scanning repository for verified secrets..."
          trufflehog filesystem . --only-verified --fail --no-update 2>&1 || {
            echo "::error::VERIFIED secrets found — publish BLOCKED"
            exit 1
          }

          echo "Scanning npm pack output for secrets..."
          mkdir -p /tmp/pack-scan
          npm pack --pack-destination /tmp/pack-scan
          cd /tmp/pack-scan
          tar xzf *.tgz
          trufflehog filesystem package/ --only-verified --fail --no-update 2>&1 || {
            echo "::error::VERIFIED secrets found in package tarball — publish BLOCKED"
            exit 1
          }

          echo "Pattern scan for common API keys..."
          PATTERNS="ghp_|github_pat_|sk-ant-|sk-[a-zA-Z0-9]{48}|AKIA[0-9A-Z]{16}|eyJ[A-Za-z0-9_-]{20,}\\.eyJ"
          # Exclude files that contain detection patterns (not actual secrets)
          if grep -rE "$PATTERNS" package/ --include='*.js' --include='*.json' --include='*.md' --include='*.yaml' --include='*.yml' --include='*.txt' --exclude='pre-publish-gate.js' --exclude='push.js' 2>/dev/null; then
            echo "::error::API key patterns found in package — publish BLOCKED"
            exit 1
          fi

          echo "Security scan PASSED"

      - name: Publish to npm
        run: npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
