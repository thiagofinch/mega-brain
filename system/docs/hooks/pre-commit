#!/bin/bash
***REMOVED***=================================
# MEGA BRAIN — Pre-Commit Secret Scanner (PHYSICAL BLOCK)
***REMOVED***=================================
# PURPOSE: Prevent credentials, API keys, and PII from being committed.
# DESIGN: fail-CLOSED — if scanning fails, commit is BLOCKED.
# INSTALLED: 2026-02-20 (post-incident hardening)
***REMOVED***=================================

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}[pre-commit] Scanning staged files for secrets...${NC}"

# Get list of staged files (only added/modified, not deleted)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM 2>/dev/null || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}[pre-commit] No staged files to scan.${NC}"
    exit 0
fi

FOUND_SECRETS=0

# === PATTERN 1: API Keys and Tokens ===
SECRET_PATTERNS=(
    # GitHub tokens
    'ghp_[A-Za-z0-9]{36}'
    'github_pat_[A-Za-z0-9_]{82}'
    'gho_[A-Za-z0-9]{36}'
    'ghs_[A-Za-z0-9]{36}'
    'ghr_[A-Za-z0-9]{36}'
    # Anthropic
    'sk-ant-[A-Za-z0-9-]{90,}'
    # OpenAI
    'sk-[A-Za-z0-9]{48}'
    # AWS
    'AKIA[0-9A-Z]{16}'
    # Supabase
    'eyJ[A-Za-z0-9_-]{20,}\.eyJ[A-Za-z0-9_-]{20,}\.[A-Za-z0-9_-]{20,}'
    # Generic secrets in assignment
    'password\s*[:=]\s*["\x27][^"\x27]{8,}'
    'api_key\s*[:=]\s*["\x27][^"\x27]{8,}'
    'secret\s*[:=]\s*["\x27][^"\x27]{8,}'
    'token\s*[:=]\s*["\x27][^"\x27]{8,}'
    # ElevenLabs
    'sk_[a-f0-9]{48}'
    # Deepgram
    '[a-f0-9]{40}'
    # N8N webhook URLs
    'https?://[^/]*\.app\.n8n\.cloud/webhook'
    # Notion integration tokens
    'ntn_[A-Za-z0-9]{40,}'
    'secret_[A-Za-z0-9]{40,}'
)

# === PATTERN 2: Sensitive file names ===
SENSITIVE_FILES=(
    '\.env$'
    '\.env\.local$'
    '\.env\.production$'
    'credentials\.json$'
    'service-account.*\.json$'
    'private[-_]?key'
    '\.pem$'
    '\.key$'
    'id_rsa'
    'id_ed25519'
)

# Check staged file names
for pattern in "${SENSITIVE_FILES[@]}"; do
    MATCHES=$(echo "$STAGED_FILES" | grep -iE "$pattern" 2>/dev/null || true)
    if [ -n "$MATCHES" ]; then
        echo -e "${RED}[BLOCKED] Sensitive file detected:${NC}"
        echo "$MATCHES" | while read -r file; do
            echo -e "  ${RED}-> $file${NC}"
        done
        FOUND_SECRETS=1
    fi
done

# Check staged file contents for secret patterns
for file in $STAGED_FILES; do
    # Skip binary files and certain extensions
    if [[ "$file" =~ \.(png|jpg|jpeg|gif|ico|woff|woff2|ttf|eot|pdf|zip|tar|gz)$ ]]; then
        continue
    fi

    # Skip security infrastructure files (contain detection patterns, not actual secrets)
    if [[ "$file" == "bin/pre-publish-gate.js" ]] || [[ "$file" == ".git/hooks/"* ]]; then
        continue
    fi

    # Skip if file doesn't exist (renamed/moved)
    if [ ! -f "$file" ]; then
        continue
    fi

    # Get staged content (not working directory content)
    STAGED_CONTENT=$(git show ":$file" 2>/dev/null || true)

    if [ -z "$STAGED_CONTENT" ]; then
        continue
    fi

    for pattern in "${SECRET_PATTERNS[@]}"; do
        MATCH=$(echo "$STAGED_CONTENT" | grep -iEn "$pattern" 2>/dev/null | head -5 || true)
        if [ -n "$MATCH" ]; then
            echo -e "${RED}[BLOCKED] Secret pattern found in: $file${NC}"
            echo "$MATCH" | while read -r line; do
                # Redact the actual secret value
                REDACTED=$(echo "$line" | sed -E 's/([A-Za-z0-9_-]{8})[A-Za-z0-9_-]{4,}/\1**REDACTED**/g')
                echo -e "  ${RED}Line: $REDACTED${NC}"
            done
            FOUND_SECRETS=1
        fi
    done
done

# === OPTIONAL: Use gitleaks if available ===
if command -v gitleaks &> /dev/null; then
    echo -e "${YELLOW}[pre-commit] Running gitleaks (enhanced scan)...${NC}"
    if ! gitleaks protect --staged --no-banner 2>/dev/null; then
        echo -e "${RED}[BLOCKED] gitleaks found secrets in staged files.${NC}"
        FOUND_SECRETS=1
    fi
fi

# === VERDICT ===
if [ "$FOUND_SECRETS" -ne 0 ]; then
    echo ""
    echo -e "${RED}============================================${NC}"
    echo -e "${RED}  COMMIT BLOCKED: Secrets detected          ${NC}"
    echo -e "${RED}============================================${NC}"
    echo -e "${YELLOW}  Fix: Remove secrets, then 'git add' again.${NC}"
    echo -e "${YELLOW}  Override (DANGEROUS): git commit --no-verify${NC}"
    echo ""
    exit 1
fi

echo -e "${GREEN}[pre-commit] No secrets found. Commit allowed.${NC}"
exit 0
